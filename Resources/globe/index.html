<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globe Test</title>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <script src="https://unpkg.com/d3-geo-projection@4"></script>
    <link rel="stylesheet" href="globe.css">
    <script src="globe.js" defer></script>
    <script  src="../JavaScripts/helpers.js" defer></script>
    <script  src="../JavaScripts/callData.js" defer></script>
    <script  src="../JavaScripts/powerData.js" defer></script>

    <script  src="../JavaScripts/header.js" defer></script>

    
    <script  src="../JavaScripts/chartEmbed.js" defer></script>
    <script src="../JavaScripts/focus.js" defer></script>
    
<!-- This installs Font Awesome-->
        <script src="https://kit.fontawesome.com/14dbedf33a.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
</head>







<header class="hBar" id="theHeaderBar">
  <h1>Cruise Data Portal</h1>

  <nav>
    <ul id="navBarItems">
      <li>Summary</li>
      <li>Vessels</li>
      <li>Services</li>
    </ul>
  </nav>

<!-- Help icon -->
<i id="help-btn" class="fa-regular fa-circle-question" title="Help" style="cursor:pointer;"></i>




  <!-- Export icon (make it a real clickable anchor with the ID your script uses) -->
  
    <i id ="download-combo"  class="fa-solid fa-database" style="cursor:pointer;" title="Download Combined Excel"></i>
  </a>
</header>

<!-- Wire up the click AFTER the element exists -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const trigger = document.getElementById('download-combo');
    if (!trigger) {
      console.error('download-combo link not found');
      return;
    }
    trigger.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const count = await CruiseExporter.download();
        console.log('Download started. Rows:', count);
      } catch (err) {
        console.error('Export failed:', err);
        alert('Export failed: ' + err.message);
      }
    });
  });
</script>

<!-- ✅ Scripts go OUTSIDE the header and load in correct order -->

<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js" ></script>
<script src="../JavaScripts/export.js" defer></script>
<!-- Font Awesome 6 CSS (for fa-solid / fa-regular icons). Put this in <head> ideally. -->
<link rel="stylesheet" ></link>

</header>



  <body>
    <div id="earth"></div>
  
    <div id="dataSpace">
      <div id="berthSpace"></div>

      <div id="cardSpace"></div>

      <div id="D3andME">

        <div class="kpiBucket" id="leftChartContainer">
          
          <div class="baseStats">

          </div>
          
          <div id="leftRadialChart" class="radial_anchor"></div>
          <div id="leftCentralChart"></div>
          <div class="glass" aria-hidden="true"></div>

        </div>
        
        <div class="kpiBucket" id="rightChartContainer">
          
          <div class="baseStats">

          </div>
        
          <div id="rightRadialChart" class="radial_anchor"></div>
          <div id="rightCentralChart"></div>
          <div class="glass" aria-hidden="true"></div>

        </div>
      </div>
    </div>
    

<!-- Tutorial Overlay Root -->
<div id="tutorial-root" hidden>
  <div class="tut-overlay" aria-hidden="true"></div>
  <div class="tut-spotlight" aria-hidden="true"></div>

  <div class="tut-panel" role="dialog" aria-modal="true" aria-labelledby="tut-title">
    <h2 id="tut-title" class="tut-title"></h2>
    <div class="tut-content"></div>
    <div class="tut-actions">
      <button type="button" class="tut-prev" aria-label="Previous step">◀ Prev</button>
      <button type="button" class="tut-next" aria-label="Next step">Next ▶</button>
      <button type="button" class="tut-done" aria-label="Finish tutorial">Done ✕</button>
    </div>
  </div>
</div>


<script>
// --- Tutorial module ---
class Tutorial {
  constructor(root = document.getElementById('tutorial-root')) {
    if (!root) throw new Error('Tutorial root element not found');
    this.root = root;
    this.overlay = root.querySelector('.tut-overlay');
    this.spotlight = root.querySelector('.tut-spotlight');
    this.panel = root.querySelector('.tut-panel');
    this.titleEl = root.querySelector('.tut-title');
    this.contentEl = root.querySelector('.tut-content');
    this.prevBtn = root.querySelector('.tut-prev');
    this.nextBtn = root.querySelector('.tut-next');
    this.doneBtn = root.querySelector('.tut-done');

    this.steps = [];
    this.index = 0;
    this.boundKeyHandler = this.onKeyDown.bind(this);

    this.prevBtn.addEventListener('click', () => this.prev());
    this.nextBtn.addEventListener('click', () => this.next());
    this.doneBtn.addEventListener('click', () => this.end());
    this.overlay.addEventListener('click', () => this.end());
    window.addEventListener('resize', () => this.render());
    window.addEventListener('scroll', () => this.render(), { passive: true });
  }

  start(steps) {
    this.steps = steps || [];
    if (!this.steps.length) return;
    this.root.hidden = false;
    this._prevOverflow = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
    this.index = 0;
    this.skipMissingTargets();
    this.render();
    this.nextBtn.focus();
    document.addEventListener('keydown', this.boundKeyHandler);
  }
  end() {
    this.root.hidden = true;
    document.body.style.overflow = this._prevOverflow || '';
    document.removeEventListener('keydown', this.boundKeyHandler);
  }
  next() {
    if (this.index < this.steps.length - 1) { this.index++; this.skipMissingTargets(); this.render(); }
    else { this.end(); }
  }
  prev() { if (this.index > 0) { this.index--; this.skipMissingTargets(true); this.render(); } }
  onKeyDown(e) {
    if (e.key === 'Escape') this.end();
    else if (e.key === 'ArrowRight' || e.key === 'Enter') this.next();
    else if (e.key === 'ArrowLeft') this.prev();
  }
  skipMissingTargets(backwards = false) {
    while (this.index >= 0 && this.index < this.steps.length) {
      const sel = this.steps[this.index]?.target;
      if (!sel) break;
      if (document.querySelector(sel)) break;
      this.index += backwards ? -1 : 1;
    }
  }
  render() {
    const step = this.steps[this.index]; if (!step) return;
    const el = step.target ? document.querySelector(step.target) : null;

    this.titleEl.textContent = step.title || `Step ${this.index + 1} of ${this.steps.length}`;
    this.contentEl.innerHTML = step.content || '';
    this.prevBtn.disabled = this.index === 0;
    this.nextBtn.textContent = this.index === this.steps.length - 1 ? 'Finish ▶' : 'Next ▶';

    if (el) {
      el.scrollIntoView({ block: 'center', inline: 'center', behavior: 'smooth' });
      const rect = el.getBoundingClientRect();
      const pad = step.padding ?? 8;
      const x = rect.left - pad, y = rect.top - pad;
      const w = rect.width + pad * 2, h = rect.height + pad * 2;

      Object.assign(this.spotlight.style, {
        left: `${x}px`, top: `${y}px`, width: `${w}px`, height: `${h}px`,
        borderRadius: `${step.radius ?? 8}px`
      });

      const panelMargin = 12;
      const viewportW = window.innerWidth, viewportH = window.innerHeight;
      const panelW = Math.min(380, viewportW * 0.9);
      const panelH = this.panel.offsetHeight || 140;

      let panelLeft = viewportW - panelW - 16;
      let panelTop = 16;

      const preferred = step.position || 'top-right';
      if (preferred === 'top-right') {
        panelLeft = Math.min(viewportW - panelW - 16, x + w + panelMargin);
        panelTop  = Math.max(16, y - panelH - panelMargin);
        if (panelTop < 0) panelTop = y + h + panelMargin;
        if (panelLeft + panelW > viewportW - 16) panelLeft = viewportW - panelW - 16;
      } else if (preferred === 'bottom') {
        panelLeft = Math.max(16, Math.min(viewportW - panelW - 16, x));
        panelTop  = y + h + panelMargin;
      } else if (preferred === 'right') {
        panelLeft = x + w + panelMargin;
        panelTop  = Math.max(16, Math.min(viewportH - panelH - 16, y));
      }

      this.panel.style.left = `${panelLeft}px`;
      this.panel.style.top  = `${panelTop}px`;
    } else {
      // Center panel if no target
      const panelW = Math.min(380, window.innerWidth * 0.9);
      this.spotlight.style.width = '0';
      this.spotlight.style.height = '0';
      this.panel.style.left = `${(window.innerWidth - panelW) / 2}px`;
      this.panel.style.top  = `20px`;
    }
  }
}
// Expose singleton
window.Tutorial = new Tutorial();

// --- Wire tutorial to Help button ---
document.addEventListener('DOMContentLoaded', () => {
  const helpBtn = document.getElementById('help-btn') || document.querySelector('.fa-circle-question');
  if (!helpBtn) return;

  // Define your steps (adjust selectors to your UI)
  const steps = [
    {
      target: 'header.hBar h1',
      title: 'Welcome to the Portal',
      content: 'This title shows the currently selected dataset.',
      position: 'bottom',
      padding: 12
    },
    {
      target: '#navBarItems li:nth-child(1)',
      title: 'Summary Tab',
      content: 'Get a quick overview of key metrics here.',
      position: 'right'
    },
    {
      target: '#download-combo',
      title: 'Export Data',
      content: 'Click here to download the combined Excel file.',
      position: 'top-right',
      radius: 12
    },
    {
      title: 'All set!',
      content: 'Use the tabs to explore. Press Finish to close the tutorial.'
    }
  ];

  helpBtn.addEventListener('click', () => window.Tutorial.start(steps));
});
</script>
``

  </body>

</html>
