<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 Gauge Arc 240°–400° (with Vessel Data)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { background-color: #ffffff; color: #000; font-family: sans-serif; }
    svg { display: block; margin: 20px auto; background-color: #ffffff; }
  </style>
</head>
<body>
  <svg id="gauge" width="600" height="600"></svg>

  <script>
    const svg = d3.select("#gauge");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    const minValue = 0, maxValue = 1.5;
    const centerX = width/2;
    const centerY = height/2;
    const radius = Math.min(width,height)/2 - 40;

    const angleScale = d3.scaleLinear()
      .domain([minValue,maxValue])
      .range([4*Math.PI/6, 12*Math.PI/6]); 

    const parseDate = d3.timeParse("%m/%d/%Y");
    const buildDateTime = (dateStr, timeStr) => {
      if (!dateStr) return null;
      const baseDate = parseDate(dateStr);
      if (!baseDate) return null;
      if (!timeStr) return baseDate;
      const parts = timeStr.split(':').map(Number);
      baseDate.setHours(parts[0]||0, parts[1]||0, parts[2]||0, 0);
      return baseDate;
    };

    Promise.all([
      d3.csv("https://raw.githubusercontent.com/EDCStanalytics/CruiseData/refs/heads/main/Actuals/CallData_Cruise.csv"),
      d3.csv("https://raw.githubusercontent.com/EDCStanalytics/CruiseData/refs/heads/main/Actuals/ShorePowerData_Cruise.csv")
    ]).then(([callData, shorePower]) => {
      const shoreLookup = new Map(
        shorePower.map(d => [d.CallID, { connect: d.Connect, disconnect: d.Disconnect }])
      );

      const data = callData.map(d => {
        const sp = shoreLookup.get(d.CallID);
        const arriveObj = buildDateTime(d.ArrivalDate, d.Arrival);
        const departObj = buildDateTime(d.DepartDate, d.Depart);
        const connectObj = sp && sp.connect ? buildDateTime(d.ArrivalDate, sp.connect) : null;
        const disconnectObj = sp && sp.disconnect ? buildDateTime(d.DepartDate, sp.disconnect) : null;
        return {
          CallID: d.CallID,
          VesselName: d.VesselName || "Unknown",
          arriveMs: arriveObj ? +arriveObj : null,
          departMs: departObj ? +departObj : null,
          connectMs: connectObj ? +connectObj : null,
          disconnectMs: disconnectObj ? +disconnectObj : null,
          ninetyAfterMs: arriveObj ? +arriveObj + 90*60*1000 : null,
          ninetyBeforeMs: departObj ? +departObj - 90*60*1000 : null
        };
      });

      const valid = data.filter(d=>d.connectMs && d.disconnectMs && d.ninetyAfterMs && d.ninetyBeforeMs);

      const groupedByShip = d3.group(valid, d => d.VesselName);
      const shipAverages = Array.from(groupedByShip, ([name, rows]) => ({
        VesselName: name,
        avgConnect: d3.mean(rows, r => r.connectMs),
        avgDisc:    d3.mean(rows, r => r.disconnectMs),
        tarConnect: d3.mean(rows, r => r.ninetyAfterMs),
        tarDisc:    d3.mean(rows, r => r.ninetyBeforeMs)
      }));

      const avgConnect = d3.mean(shipAverages, s => s.avgConnect);
      const avgDisc    = d3.mean(shipAverages, s => s.avgDisc);
      const tarConnect = d3.mean(shipAverages, s => s.tarConnect);
      const tarDisc    = d3.mean(shipAverages, s => s.tarDisc);

      let ratio = (avgConnect && avgDisc && tarConnect && tarDisc && (tarDisc-tarConnect)!=0)
        ? (avgDisc-avgConnect)/(tarDisc-tarConnect) : 0;

      const usedValue = Math.min(Math.max(minValue,ratio),maxValue);
      
            const vesselNames = Array.from(new Set(data.map(d => d.VesselName))).filter(Boolean);
      const select = d3.select("#vesselSelect");
      select.append("option").text("All Vessels").attr("value", "all");
      vesselNames.forEach(name => select.append("option").text(name).attr("value", name));



      // Draw outer circle
      svg.append("circle")
        .attr("cx", centerX).attr("cy", centerY)
        .attr("r", radius)
        .attr("fill","none")
        .attr("stroke","#555")
        .attr("stroke-width",2);

      // Tick marks
      const tickValues = d3.range(minValue, maxValue+0.006, 0.1);
      tickValues.forEach(val => {
        const angle = angleScale(val);
        const x1 = centerX + radius * Math.cos(angle);
        const y1 = centerY + radius * Math.sin(angle);
        const x2 = centerX + (radius-40) * Math.cos(angle);
        const y2 = centerY + (radius-40) * Math.sin(angle);

        svg.append("line")
          .attr("x1",x1).attr("y1",y1)
          .attr("x2",x2).attr("y2",y2)
          .attr("stroke","#000").attr("stroke-width",2);

        svg.append("text")
          .attr("x", centerX + (radius-70) * Math.cos(angle))
          .attr("y", centerY + (radius-70) * Math.sin(angle))
          .attr("text-anchor","middle")
          .attr("dominant-baseline","middle")
          .style("fill","#000").style("font-size","12px")
          .text(val.toFixed(1));
      });

      const needleAngle = angleScale(ratio);

 const needleLen = radius - 60;
    const needleWidth = 10; 
      const tipX = centerX + needleLen * Math.cos(needleAngle);
    const tipY = centerY + needleLen * Math.sin(needleAngle);

    const leftBaseX = centerX + needleWidth * Math.cos(needleAngle - Math.PI/2);
    const leftBaseY = centerY + needleWidth * Math.sin(needleAngle - Math.PI/2);

    const rightBaseX = centerX + needleWidth * Math.cos(needleAngle + Math.PI/2);
    const rightBaseY = centerY + needleWidth * Math.sin(needleAngle + Math.PI/2);

    const needlePath = d3.path();
    needlePath.moveTo(leftBaseX, leftBaseY);
    needlePath.lineTo(rightBaseX, rightBaseY);
    needlePath.lineTo(tipX, tipY);
    needlePath.closePath();
    
      svg.append("path")
      .attr("d", needlePath.toString())
      .attr("fill","red");

      // Center hub
      svg.append("circle")
        .attr("cx",centerX).attr("cy",centerY)
        .attr("r",10).attr("fill","#000");

      // Digital readout
      svg.append("text")
        .attr("x",centerX).attr("y",centerY+radius+30)
        .attr("text-anchor","middle")
        .style("font-size","18px").style("fill","#0f0")
        .text(d3.format(".2f")(ratio));
    });
  </script>
</body>
</html>
